<!doctype html>

<html lang="en">

<head>
  <meta charset="utf-8">
  <title>urobot-web</title>
  <style>
    #output {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
    }

    html {
      box-sizing: border-box;
    }
    *, *:before, *:after {
      box-sizing: inherit;
    }

    .u-robot-drawer__world {
      position: relative;
      margin: 0 auto;
      /* border: 1px solid #ddd; */
    }

    .u-robot-drawer__world-cell {
      float: left;
      margin: 0;
      padding: 0;
      border-left: 1px solid #ddd;
      z-index: 101;
    }

    .u-robot-drawer__world-cell:last-of-type {
      border-right: 1px solid #ddd;
    }

    .u-robot-drawer__world-row {
      margin: 0;
      padding: 0;
      border-top: 1px solid #ddd;
      z-index: 100;
    }

    .u-robot-drawer__world-row:last-of-type {
      border-bottom: 1px solid #ddd;
    }

    .u-robot-drawer__beeper {
      position: absolute;
      z-index: 104;
      border-radius: 50%;
      background-color: #ff0;
      color: black;
      text-align: center;
      font-size: 16px;
      padding-top: calc(50% - 8px);
    }

    .u-robot-drawer__beeper--invisible {
      display: none;
    }

    .u-robot-drawer__piece {
      position: absolute;
      z-index: 105;
      transition: left 0.5s, top 0.5s;
    }

    .u-robot-drawer__piece--type-robot {
      background-size: 50% 70%;
      background-position: center;
      background-repeat: no-repeat;
    }

    .u-robot-drawer__piece--type-robot.u-robot-drawer__piece--direction-r {
      background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAAeCAMAAAAfOR5kAAAACXBIWXMAAA7EAAAOxAGVKw4bAAADAFBMVEUAAAAzMzNbW1v/AACAgICkpKTAwMD///8AAAAS8uhyd1MAAAABD3UAADYAAAAAAFAAABkAAAGFBJ4AAAkAADYAAAAAAFAAABkAAAAAAAAAABQAABcAAAkAAAQAAAQAAAQAAATxogDxoeQBD3UAADkAAAMAABMAABMBDusAAAAAACYFDpQAAAAAACaqAAD///8V5iAV5hgS9XC1WqAS85wBDwG2L+RFNyAAABMAABMBDutPyjgS9CC1WqC1VShP0RYAAABPyji1WqAS9CC1RBxP7jMAAAIBD3UAADkAAAMAABMAABMV5iAS9BhBx0G1DExCx4VCx43LD8i1DGxFM5sS9BhFM7JFM7oS9LRFM8QS9BgS9JjLD8jLD8i1WqAS9DBCWLYABAEAAAC6Z1AAAAES9FzUhzRTBRAABAEAAAC6Z1DLD8i6q80AAAAS9JgS9HTUtqPUhPzUhaQDBRoAAAEWIagWIcgABAAWX8gAAADUtik94ZFTBRAS9SwAAAAWX8g94ZwAAAAAAAAABAAAABMS9RAS9TjXBGfUiDD////UiCrUuJsAAADLD8hTBRAABAEAAAC6Z1B+cqwAAAEAAAAAAAAAAAAAAACKACEABADV8+N+cph+8XAAAAAAAAQAAaYAAAIABAAAABMWIcgBCJ4AAAAAAAAAAAAAAAAAAAAAAAAAAAAS8HSAFjwAAAUAAAVI2FSAGByAGKxI2GAAb1oS9fw97BsWX8gAAAAWIUgAAAQAAAAS9mQ95ZgAAADXIloAAAAS9bzUtqPUhPzUhaQDBRoAAAEAAAAWX8gWIUgDBQES9dDUwr8S9gA90ZMDBRo95ZgWX8jUiKYAAAAAAAIAAMgAABMWIVAS9ijUhzRTBRAAAA8AAAAAAAA95Zi6q80AAAAS9mQ95ZgS9pDUi9n90AAS9pDUiFoS9lDUiCoAAA895ZgS+WgAABQAAAEAAAAAAAAAABAAAAAAAFAAAAEAAAAAAAAS9kTxbGQS+TjXBGfUiDD////UiCoAAAAAAADKTwNHAAAACHRSTlP/////////AN6DvVkAAAB6SURBVHjardCLCsAgCAXQO7P8/z+eyVxWEgzmKNghfEEES5CoqV5E7FFbIzKOao5SjJknj0yoGbt2fnKfOCQJHEt+43Lkdcp8J8bbBmEb7Jemh35cq/07axJjzhjIuJ+dsb/2iZaSc3fO3qO88T+PmpF5TB+YMp4bvwEGcAqR53QgIgAAAABJRU5ErkJggg==);
    }

    .u-robot-drawer__piece--type-robot.u-robot-drawer__piece--direction-d {
      background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAAeCAMAAAAfOR5kAAAACXBIWXMAAA7EAAAOxAGVKw4bAAADAFBMVEUAAAA3NzdbW1v/AAD//wCAgICjo6PAwMD///8S8uhyd1MAAAABELAAADYAAAAAAFAAABkAAAGFBoMAAAkAADYAAAAAAFAAABkAAAAAAAAAABQAABcAAAkAAAQAAAQAAAQAAATxogDxoeQBELAAADkAAAMAABMAABMBDy0AAAAAACYFESAAAAAAACaqAAD///8V5iAV5hgS9XC1WqAS85wBEAG2L+RFNyAAABMAABMBDy1PyjgS9CC1WqC1VShP0RYAAABPyji1WqAS9CC1RBxP7jMAAAIBELAAADkAAAMAABMAABMV5iAS9BhBx0G1DExCx4VCx43LD8i1DGxFM5sS9BhFM7JFM7oS9LRFM8QS9BgS9JjLD8jLD8i1WqAS9DBCWLYABAEAAADA+CAAAAES9FzUhzQRBWIABAEAAADA+CDLD8i6q80AAAAS9JgS9HTUtqPUhPzUhaQlBV4AAAEWIagWIcgABAAWX8gAAADUtik94ZERBWIS9SwAAAAWX8g94ZwAAAAAAAAABAAAABMS9RAS9TjXBGfUiDD////UiCrUuJsAAADLD8gRBWIABAEAAADA+CB/zwQAAAEAAAAAAAAAAAAAAACKACEABADV8+N/zvB/a8gAAAAAAAQAAaYAAAIABAAAABMWIcgBCrEAAAAAAAAAAAAAAAAAAAAAAAAAAAAS8HSAFjwAAAUAAAXcCFSAGByAGKzcCGAArugS9fw97BsWX8gAAAAWIUgAAAQAAAAS9mQ95ZgAAADXIloAAAAS9bzUtqPUhPzUhaQlBV4AAAEAAAAWX8gWIUglBQES9dDUwr8S9gA90ZMlBV495ZgWX8jUiKYAAAAAAAIAAMgAABMWIVAS9ijUhzQRBWIAAA8AAAAAAAA95Zi6q80AAAAS9mQ95ZgS9pDUi9n94AAS9pDUiFoS9lDUiCoAAA895ZgS+WgAABQAAAEAAAAAAAAAABAAAAAAAFAAAAEAAAAAAAAS9kTxbGQS+TjXBGfUiDD////UiCoAAAAAAAAJXRdjAAAACXRSTlP//////////wBTT3gSAAAAnklEQVR42sWSSxLEIAhEW0TD/U88fKMp3Q+L2HlFoMFABEcoE7RGY4v5EBzT6D2ZifkE1pfkLhzjhpvjo4jFt2NiueFoeccUvXp23vA5jnrc+Zwx/LkU8Z18s4dmN4c0eFHWMlTT8KLvmFjcjuqAAvGAbNhQfOLY3IQT5nQi5ZuqIMZEYUv3U1Uk/wkjDboyg7HvvB7kXHZnmV0/5Kt+x38Kzw6IUBEAAAAASUVORK5CYII=);
    }

    .u-robot-drawer__piece--type-robot.u-robot-drawer__piece--direction-u {
      background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAAeCAMAAAAfOR5kAAAACXBIWXMAAA7EAAAOxAGVKw4bAAADAFBMVEUAAAA1NTVZWVn//wCAgICsrKzAwMD////XBGfUxJj////UxJPXZEgLBoIBC/EAAICp+MAAACQAAAGhoaIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAS5+jxWDYBC/Gp+MAAAIDUhLLUhr4BC/EAADkS6CTY57ILBoIBC/ELBoKp+MAAABgAAALaFogAABUS6HzXOZWp+NALBoK1WqAS6GAS6QG2L+RFNyALBoIAAIAAAAFPyjgS6OS1WqC1VShP0RYAAABPyji1WqAS6OS1RBxP7jPXNnrY5zIAAAAAAAEAAAAAAADUi9kS6NxBx0G1DExCx4VCx43LD8i1DGxFM5sS6NxFM7JFM7oS6XhFM8QS6NwS6VzLD8jLD8i1WqAS6PRCWLYABAEAAADBLUQAAAES6SDUhzQRBWIABAEAAADBLUTLD8i6q80AAAAS6VwS6TjUtqPUhPzUhaQlBV4AAAEWIagWIcgABAAWX8gAAADUtik94ZERBWIS6fAAAAAWX8g94ZwAAAAAAAAABAAAABMAAAAS6fzXBGfUiDD////UiCrUuJsAAADLD8gRBWIABAEAAADBLUR/zwQAAAEAAAAAAAAAAAAAAACKACEABADV8+N/zvB/a8gAAAAAAAQAAaYAAAIABAAAABMWIcgBC/EAAAAAAAAAAAAAAAAAAAAAAAAAAAAS5TiAFjwAAAUAAAXcAqSAGByAGKzcArAArugS6sA97BsWX8gAAAAWIUgAAAQAAAAS6yg95ZgAAAAS6ojUhzQS6oDUtqPUhPzUhaQlBV4AAAEAAAAWX8gWIUglBQES6pTUwr8S6sQ90ZMlBV495ZgWX8jUiKYAAAAAAAIAAMgAABMWIVAS6uzUhzQRBWIAAA8AAAAAAAA95Zi6q80AAAAS6yg95ZgS61TUi9n94AAS61TUiFoS6xTUiCoAAA895ZgS7iwAABQAAAEAAAAAAAAAABAAAAALBoIAAAEAAAAAAAAS6wjxbGQS7fzXBGfUiDD////UiCoAAAAAAABePXMrAAAACHRSTlP/////////AN6DvVkAAACXSURBVHjaxZLhCoQwDIOzbl7f/41vSdsx0RP8dWNg+YhtUoU7LmeySVuzsc5xfAzEzTYqnnicjjDuMF7iH70f8L3BU5yRcRhz03Mgw1+X4rEThLb3kMseWr7ddTXTKLWixUfERGpTXxNQHeLCF96bCNONra6dTrx8WzUE/SWmXM9ZhfhPGGlQVSxQOJaFyKVPmer6IVf1BbCqCS9jk1GTAAAAAElFTkSuQmCC);
    }

    .u-robot-drawer__piece--type-robot.u-robot-drawer__piece--direction-l {
      background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAAeCAMAAAAfOR5kAAAACXBIWXMAAA7EAAAOxAGVKw4bAAADAFBMVEUAAAAzMzNbW1v/AACAgICkpKTAwMD////XBGfUxJj////UxJPXZEgQCQABCJgAAICpsbAAACQAAAGhoaIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAS5+jxWDYBCJipsbAAAIDUhLLUhr4BCJgAADkS6CTY57IQCQABCJgQCQCpsbAAABgAAALaFogAABUS6HzXOZWpscAQCQC1WqAS6GAS6QG2L+RFNyAQCQAAAIAAAAFPyjgS6OS1WqC1VShP0RYAAABPyji1WqAS6OS1RBxP7jPXNnrY5zIAAAAAAAEAAAAAAADUi9kS6NxBx0G1DExCx4VCx43LD8i1DGxFM5sS6NxFM7JFM7oS6XhFM8QS6NwS6VzLD8jLD8i1WqAS6PRCWLYABAEAAAC7q7gAAAES6SDUhzQMCQgABAEAAAC7q7jLD8i6q80AAAAS6VwS6TjUtqPUhPzUhaQXAywAAAEWIhgWIjgABAAWYDgAAADUtik94ZEMCQgS6fAAAAAWYDg94ZwAAAAAAAAABAAAABMAAAAS6fzXBGfUiDD////UiCrUuJsAAADLD8gMCQgABAEAAAC7q7h/uXwAAAEAAAAAAAAAAAAAAACKACEABADV8+N/uWh/mfgAAAAAAAQAAaYAAAIABAAAABMWIjgBEtkAAAAAAAAAAAAAAAAAAAAAAAAAAAAS5TiAFjwAAAUAAAUj8qSAGByAGKwj8rAAc0YS6sA97BsWYDgAAAAWIbgAAAQAAAAS6yg95ZgAAAAS6ojUhzQS6oDUtqPUhPzUhaQXAywAAAEAAAAWYDgWIbgXAwES6pTUwr8S6sQ90ZMXAyw95ZgWYDjUiKYAAAAAAAIAAMgAABMWIcAS6uzUhzQMCQgAAA8AAAAAAAA95Zi6q80AAAAS6yg95ZgS61TUi9n98AAS61TUiFoS6xTUiCoAAA895ZgS7iwAABQAAAEAAAAAAAAAABAAAAAQCQAAAAEAAAAAAAAS6wjxbGQS7fzXBGfUiDD////UiCoAAAAAAAAQ6+rlAAAACHRSTlP/////////AN6DvVkAAAB9SURBVHjardBBDsAgCATABaX8/8dFjBWVHpqUk5kAAlBVbMFGTYm4jhC5mBWlLOqOzlHNN2bIw9Z7ZiNlTpmRZ4cv37h8Yk23zG7ifFwQfsEWVtB2hDfWwLVzlY2tOOV+qiQbJ9PcJfAy3sP+HKn/cv/rZIrTbSx5kzG0xQ39dAqxz8DMUwAAAABJRU5ErkJggg==);
    }

    .u-robot-drawer__piece--type-beeper {
      display: none;
    }
  </style>
  <script>
    class URobotDrawer {
      constructor(container) {
        this.container = container;
        this.initWorld();
      }

      initWorld() {
        this.world = document.createElement('div');
        this.world.className = 'u-robot-drawer__world';
        this.container.appendChild(this.world);
        this.pieceElements = {};
        this.pieces = {};
        this.beeperElements = {};
      }

      scaleWorld() {
        const containerWidth = this.container.offsetWidth;
        const containerHeight = this.container.offsetHeight;

        const cellSizeForWidthFit = containerWidth / this.worldWidth;
        const worldHeightForWidthFit = cellSizeForWidthFit * this.worldHeight;
        if (containerHeight > worldHeightForWidthFit) {
          this.scaleWorldWidthFit();
        } else {
          this.scaleWorldHeightFit(); 
        }
      }

      drawGrid() {
        this.cells = {}
        for (let i = this.worldHeight - 1; i >= 0; i--) {
          this.cells[i] = {};
          const row = document.createElement('div');
          row.className = 'u-robot-drawer__world-row';
          row.style.width = '100%';
          row.style.height = `${this.worldCellSize}px`;
          this.world.appendChild(row);
          for (let j = 0; j < this.worldWidth; j++) {
            const cell = document.createElement('div');
            this.cells[i][j] = cell;
            cell.className = 'u-robot-drawer__world-cell';
            cell.style.width = `${this.worldCellSize}px`;
            cell.style.height = `${this.worldCellSize}px`;
            row.appendChild(cell);
          }
        }
      }

      scaleWorldWidthFit() {
        const containerWidth = this.container.offsetWidth;
        const containerHeight = this.container.offsetHeight;
        const worldWidthPixels = containerWidth;
        this.worldCellSize = worldWidthPixels / this.worldWidth;
        const worldHeightPixels = this.worldCellSize * this.worldHeight; 
        this.setWorldSize(worldWidthPixels, worldHeightPixels)
        const worldPaddingTop = (containerHeight - worldHeightPixels) / 2;
        this.world.style.paddingTop = `${worldPaddingTop}px`;
      }

      scaleWorldHeightFit() {
        const containerWidth = this.container.offsetWidth;
        const containerHeight = this.container.offsetHeight;
        const worldHeightPixels = containerHeight;
        this.worldCellSize = worldHeightPixels / this.worldHeight
        const worldWidthPixels = this.worldCellSize * this.worldWidth;
        this.setWorldSize(worldWidthPixels, worldHeightPixels)
      }

      setWorldSize(width, height) {
        this.world.style.width = `${width}px`;
        this.world.style.height = `${height}px`;
      }

      setPieceClasses(piece, pieceType, direction) {
        const classNames = [
          `u-robot-drawer__piece`,
          `u-robot-drawer__piece--type-${pieceType}`,
          `u-robot-drawer__piece--direction-${direction}`,
        ];
        piece.className = classNames.join(' ');
      }

      setPiecePosition(piece, x, y) {
        piece.style.left = `${this.worldCellSize * x}px`;
        piece.style.top = `${this.worldCellSize * (this.worldHeight - 1 - y)}px`;
      }

      onDrawWorld(task) {
        this.worldWidth = task.width;
        this.worldHeight = task.height;
        this.scaleWorld();
        this.drawGrid();
      }

      onDrawWall(task) {
        const targetCell = this.cells[task.y1][task.x1];
        if (task.x1 === task.x2) {
          if (task.y1 + 1 === task.y2) {
            targetCell.style.borderTop = '1px solid #222';
          } else if (task.y1 - 1 === task.y2) {
            targetCell.style.borderBottom = '1px solid #222';
          }
        } else if (task.y1 === task.y2) {
          if (task.x1 + 1 === task.x2) {
            targetCell.style.borderRight = '1px solid #222';
          } else if (task.x1 - 1 === task.x2) {
            targetCell.style.borderLeft = '1px solid #222';
          }
        }
      }

      getBeeperCount(x, y) {
        let count = 0;
        for (const piece of this.pieces) {
          if (piece.piece_type === 'beeper' && piece.x === x && piece.y === y) {
            count++;
          }
        }
        return count;
      }

      getBeeperElement(x, y) {
        let beeperElement = this.beeperElements[`${x},${y}`];
        if (!beeperElement) {
          beeperElement = document.createElement('div');
          beeperElement.style.width = `${this.worldCellSize}px`;
          beeperElement.style.height = `${this.worldCellSize}px`;
          this.setPiecePosition(beeperElement, x, y);
          this.world.appendChild(beeperElement);
          this.beeperElements[`${x},${y}`] = beeperElement;
        }
        return beeperElement;
      }

      refreshBeeperElement(x, y) {
        const beeperElement = this.getBeeperElement(x, y);
        const beeperCount = this.getBeeperCount(x, y);
        if (beeperCount > 0) { 
          beeperElement.className = `u-robot-drawer__beeper`;
          beeperElement.innerHTML = beeperCount;
        } else {
          beeperElement.className = `u-robot-drawer__beeper u-robot-drawer__beeper--invisible`;
        }
      }

      onDrawPiece(task) {
        const pieceElement = document.createElement('div');
        pieceElement.style.width = `${this.worldCellSize}px`;
        pieceElement.style.height = `${this.worldCellSize}px`;
        this.pieceElements[task.piece_id] = pieceElement;
        this.pieces[task.piece_id] = {
          piece_id: task.piece_id,
          piece_type: task.piece_type,
          x: task.x,
          y: task.y,
          direction: task.direction,
        };
        if (task.piece_type === 'beeper') {
          this.refreshBeeperElement(task.x, task.y);
        }
        this.setPieceClasses(pieceElement, task.piece_type, task.direction);
        this.setPiecePosition(pieceElement, task.x, task.y);
        this.world.appendChild(pieceElement);
      }

      onRemovePiece(task) {
        const pieceElement = this.pieceElements[task.piece_id];
        const piece = this.pieces[task.piece_id];
        if (piece.piece_type === 'beeper') {
          this.refreshBeeperElement(piece.x, piece.y);
        }
        this.world.removeChild(pieceElement);
        delete this.pieceElements[task.piece_id];
        delete this.pieces[task.piece_id];
      }

      onMovePiece(task) {
        const pieceElement = this.pieceElements[task.piece_id];
        this.setPiecePosition(pieceElement, task.x, task.y);
        this.pieces[task.piece_id].x = task.x;
        this.pieces[task.piece_id].y = task.y;
      }

      onRotatePiece(task) {
        const pieceElement = this.pieceElements[task.piece_id];
        const piece = this.pieces[task.piece_id];
        this.setPieceClasses(pieceElement, piece.piece_type, task.direction);
        piece.direction = task.direction;
      }

      onTask(taskMessage) {
        const task = JSON.parse(taskMessage);
        console.log(task);
        switch (task.task) {
          case 'draw_world':
            this.onDrawWorld(task);
            break;
          
          case 'draw_wall':
            this.onDrawWall(task);
            break;

          case 'draw_piece':
            this.onDrawPiece(task);
            break;

          case 'remove_piece':
            this.onRemovePiece(task);
            break;

          case 'move_piece':
            this.onMovePiece(task);
            break;

          case 'rotate_piece':
            this.onRotatePiece(task);
            break;
        
          default:
            break;
        }
      }
    }
    
    function init() {
      const drawer = new URobotDrawer(document.getElementById('output'));
      const ws = new WebSocket("ws://localhost:8888/websocket");
      ws.onopen = function () {

      };
      ws.onmessage = function (e) {
        drawer.onTask(e.data);
      };
    }

    window.onload = init;
  </script>
</head>

<body>
  <div id="output"></div>
</body>

</html>